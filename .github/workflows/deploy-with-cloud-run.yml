name: 'A simple test workflow'

on: [push]

jobs:

    publish-image:

      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v2

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: 'gcloud-cli-setup'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'docker-credential-helper-setup'
        run: 'gcloud auth configure-docker ${{ vars.ARTEFACT_REGISTRY_HOSTNAME}}'

      - name: 'build-docker-image'
        run: 'docker build -t ${{ vars.APP_NAME }}:latest .; docker images | grep ${{ vars.APP_NAME }}'

      - name: 'tag-docker-image'
        run: 'docker tag ${{ vars.APP_NAME}}:latest ${{ vars.ARTEFACT_REGISTRY_ROOT}}/${{ vars.APP_NAME }}:latest'

      - name: 'gcloud-info'
        run: 'gcloud info'

      - name: 'gcloud-artefact-repos'
        run: 'gcloud artifacts repositories list'  

      - name: 'push-docker-image'
        run: 'docker push ${{ vars.ARTEFACT_REGISTRY_ROOT}}/${{ vars.APP_NAME }}:latest'

    deploy-cloud-run:
      needs: publish-image

      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v2



      - name: 'terraform-plan'
        run: |
          echo "- Export Secret to credentials.json"
          echo '${{ secrets.ALT_CREDENTIAL_CONTENT }}' | base64 -d > credentials.json
          echo "- View the files in the current directory"
          ls -halt
          echo "- Change to the terraform directory"
          cd terraform
          echo "- Run terraform plan"
          terraform plan -var "SERVICE_NAME=MyServiceName" -var "DOCKER_IMAGE_LOCATION=google.com/something"
